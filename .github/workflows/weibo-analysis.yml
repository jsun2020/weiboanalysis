name: Weibo Hot Analysis

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ 9:00 å’Œ 18:00
  schedule:
    - cron: '0 1 * * *'   # UTC 01:00 = åŒ—äº¬æ—¶é—´ 09:00
    - cron: '0 10 * * *'  # UTC 10:00 = åŒ—äº¬æ—¶é—´ 18:00

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      top_n:
        description: 'åˆ†æçƒ­æœæ•°é‡'
        required: false
        default: 'top10'
        type: choice
        options:
          - top5
          - top10
          - top15
          - top20

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªå®ä¾‹
concurrency:
  group: weibo-analysis
  cancel-in-progress: true

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install dependencies
        run: npm ci

      # 4. è¿è¡Œåˆ†æ
      - name: Run Weibo Hot Analysis
        id: analyze
        env:
          YUNWU_API_KEY: ${{ secrets.YUNWU_API_KEY }}
          API_BASE_URL: "https://yunwu.ai"
          MODEL_ID: "claude-sonnet-4-5-20250929"
          TIANAPI_KEY: ${{ secrets.TIANAPI_KEY }}
        run: |
          TOP_N="${{ github.event.inputs.top_n || 'top10' }}"
          echo "Analyzing with: $TOP_N"
          npm run analyze -- $TOP_N

      # 5. ä¸Šä¼ æŠ¥å‘Šä¸º Artifact
      - name: Upload Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: weibo-analysis-report-${{ github.run_number }}
          path: reports/*.html
          retention-days: 30

      # 6. æäº¤æŠ¥å‘Šåˆ°ä»“åº“ï¼ˆå¯é€‰ï¼‰
      - name: Commit Report to Repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add reports/*.html
          git diff --staged --quiet || git commit -m "Add weibo analysis report - $(date '+%Y-%m-%d %H:%M')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å¯é€‰ï¼šéƒ¨ç½²åˆ° GitHub Pages
  # æ³¨æ„ï¼šéœ€è¦å…ˆåœ¨ä»“åº“ Settings > Pages ä¸­å¯ç”¨ GitHub Pagesï¼Œå¹¶é€‰æ‹© "GitHub Actions" ä½œä¸º Source
  deploy-pages:
    needs: analyze
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    continue-on-error: true  # å¦‚æœ Pages æœªå¯ç”¨ï¼Œä¸é˜»å¡æ•´ä¸ªå·¥ä½œæµ

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main  # æ‹‰å–æœ€æ–°æäº¤ï¼ˆåŒ…å«æ–°æŠ¥å‘Šï¼‰

      - name: Pull latest changes
        run: git pull origin main

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Create index page
        run: |
          cd reports
          # ç”ŸæˆæŠ¥å‘Šåˆ—è¡¨ JSON
          echo "const reports = [" > reports.js
          first=true
          for f in $(ls -t weibo-hot-analysis-*.html 2>/dev/null | head -20); do
            if [ "$f" != "index.html" ]; then
              # æå–æ—¶é—´æˆ³ YYYYMMDDHHMMSS (14ä½æ•°å­—)
              ts=$(echo $f | grep -oE '[0-9]{14}' || echo "")
              if [ -n "$ts" ]; then
                # æ ¼å¼åŒ–ä¸ºå¯è¯»æ—¶é—´ YYYY-MM-DD HH:MM:SS
                date_str=$(echo $ts | sed 's/\(....\)\(..\)\(..\)\(..\)\(..\)\(..\)/\1-\2-\3 \4:\5:\6/')
                if [ "$first" = true ]; then
                  first=false
                else
                  echo "," >> reports.js
                fi
                echo "  {\"file\": \"$f\", \"timestamp\": \"$ts\", \"display\": \"$date_str\"}" >> reports.js
              fi
            fi
          done
          echo "];" >> reports.js

          # ç”Ÿæˆäº¤äº’å¼ index.html
          cat > index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>å¾®åšçƒ­æœäº§å“åˆ›æ„åˆ†ææŠ¥å‘Š</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
              .header { padding: 2rem 2rem; color: white; text-align: center; }
              .header h1 { font-size: 2.5rem; margin-bottom: 1rem; font-weight: bold; }
              .header h1::before { content: "ğŸ”¥ "; }
              .selector-container { display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap; }
              .selector-label { font-size: 1rem; opacity: 0.9; }
              .time-selector {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
                border: none;
                border-radius: 2rem;
                background: rgba(255,255,255,0.2);
                color: white;
                cursor: pointer;
                min-width: 220px;
              }
              .time-selector option { color: #1f2937; background: white; }
              .time-selector:focus { outline: none; background: rgba(255,255,255,0.3); }
              .refresh-btn {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
                border: none;
                border-radius: 2rem;
                background: rgba(255,255,255,0.9);
                color: #764ba2;
                cursor: pointer;
                font-weight: 500;
              }
              .refresh-btn:hover { background: white; }
              .summary-section {
                margin-top: 1.5rem;
                display: none;
              }
              .summary-section.visible { display: block; }
              .summary-text {
                font-size: 1.1rem;
                background: rgba(255,255,255,0.2);
                display: inline-block;
                padding: 0.5rem 1.5rem;
                border-radius: 2rem;
                margin-bottom: 1rem;
              }
              .stats-bar {
                display: flex;
                justify-content: center;
                gap: 1.5rem;
                flex-wrap: wrap;
              }
              .stat-item {
                background: rgba(255,255,255,0.15);
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                min-width: 100px;
              }
              .stat-value { font-size: 1.5rem; font-weight: bold; }
              .stat-label { font-size: 0.85rem; opacity: 0.9; }
              .content-frame {
                width: 100%;
                height: calc(100vh - 280px);
                border: none;
                background: white;
              }
              .no-reports {
                text-align: center;
                padding: 4rem;
                color: white;
                font-size: 1.25rem;
              }
              .footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 0.5rem;
                background: rgba(0,0,0,0.1);
                text-align: center;
                color: rgba(255,255,255,0.7);
                font-size: 0.75rem;
              }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>å¾®åšçƒ­æœäº§å“åˆ›æ„åˆ†ææŠ¥å‘Š</h1>
              <div class="selector-container">
                <span class="selector-label">ç”Ÿæˆæ—¶é—´:</span>
                <select id="reportSelector" class="time-selector" onchange="loadReport(this.value)">
                  <option value="">-- åŠ è½½ä¸­ --</option>
                </select>
                <button class="refresh-btn" onclick="refreshPage()">ğŸ”„ åˆ·æ–°</button>
              </div>
              <div id="summarySection" class="summary-section">
                <p class="summary-text" id="summaryText">åŠ è½½ä¸­...</p>
                <div class="stats-bar">
                  <div class="stat-item">
                    <div class="stat-value" id="excellentCount">-</div>
                    <div class="stat-label">ä¼˜ç§€åˆ›æ„</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value" id="goodCount">-</div>
                    <div class="stat-label">è‰¯å¥½åˆ›æ„</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value" id="normalCount">-</div>
                    <div class="stat-label">å…¶ä»–åˆ›æ„</div>
                  </div>
                </div>
              </div>
            </div>
            <iframe id="reportFrame" class="content-frame" src="about:blank"></iframe>
            <div class="footer">Powered by Anthropic SDK + GitHub Actions | è‡ªåŠ¨æ›´æ–°: æ¯å¤© 09:00 & 18:00</div>

            <script src="reports.js"></script>
            <script>
              function initSelector() {
                const selector = document.getElementById('reportSelector');
                selector.innerHTML = '';
                if (typeof reports === 'undefined' || reports.length === 0) {
                  selector.innerHTML = '<option value="">æš‚æ— æŠ¥å‘Š</option>';
                  return;
                }
                reports.forEach((r, i) => {
                  const opt = document.createElement('option');
                  opt.value = r.file;
                  opt.textContent = r.display;
                  if (i === 0) opt.selected = true;
                  selector.appendChild(opt);
                });
                // è‡ªåŠ¨åŠ è½½æœ€æ–°æŠ¥å‘Š
                if (reports.length > 0) {
                  loadReport(reports[0].file);
                }
              }

              function loadReport(file) {
                if (!file) return;
                const frame = document.getElementById('reportFrame');
                frame.src = file;
                // ç›‘å¬ iframe åŠ è½½å®Œæˆåæå–ç»Ÿè®¡æ•°æ®
                frame.onload = function() {
                  extractStats();
                };
              }

              function extractStats() {
                try {
                  const frame = document.getElementById('reportFrame');
                  const doc = frame.contentDocument || frame.contentWindow.document;

                  // æå–ç»Ÿè®¡æ•°æ®
                  const summaryEl = doc.querySelector('.summary');
                  const statItems = doc.querySelectorAll('.stat-item');

                  if (summaryEl) {
                    document.getElementById('summaryText').textContent = summaryEl.textContent;
                  }

                  if (statItems.length >= 3) {
                    const values = [];
                    statItems.forEach(item => {
                      const val = item.querySelector('.stat-value');
                      if (val) values.push(val.textContent);
                    });
                    if (values.length >= 3) {
                      document.getElementById('excellentCount').textContent = values[0];
                      document.getElementById('goodCount').textContent = values[1];
                      document.getElementById('normalCount').textContent = values[2];
                    }
                  }

                  // æ˜¾ç¤ºæ‘˜è¦åŒºåŸŸ
                  document.getElementById('summarySection').classList.add('visible');
                } catch (e) {
                  console.log('æ— æ³•æå–ç»Ÿè®¡æ•°æ®:', e);
                }
              }

              function refreshPage() {
                location.reload(true);
              }

              // åˆå§‹åŒ–
              document.addEventListener('DOMContentLoaded', initSelector);
            </script>
          </body>
          </html>
          HTMLEOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: reports

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
